<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>PXN / Custom Keymap Editor</title>

<style>
body{
    font-family:Segoe UI;
    background:#111;
    color:#fff;
    text-align:center;
}

/* ===== ç”»åƒ + ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */

#stage{
    position:relative;
    display:inline-block;
    border:2px solid #333;
    margin-top:15px;
}

#bg{
    display:block;
    max-width:700px;
}

.key{
    position:absolute;
    background:rgba(0,0,0,.55);
    border:2px solid #555;
    border-radius:8px;
    font-size:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
}

.key.selected{
    border-color:#00ff88;
    box-shadow:0 0 8px #00ff88;
}

.panel{
    margin:8px;
}

input{padding:6px;}
button{padding:6px 10px;margin:3px;}
</style>
</head>

<body>

<h2>ğŸ® Universal Keymap Layout Editor</h2>

<div class="panel">
ç”»åƒ:
<input type="file" accept="image/*" onchange="loadImage(event)">
</div>

<div class="panel">
<button onclick="addKey()">ï¼‹ã‚­ãƒ¼è¿½åŠ </button>
<button onclick="save()">ä¿å­˜</button>
<button onclick="load()">èª­è¾¼</button>
<button onclick="exportKeymap()">keymap.cå‡ºåŠ›</button>
</div>

<div class="panel">
ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰:
<input id="keyInput" oninput="updateKey(this.value)">
</div>

<div id="stage">
<img id="bg">
</div>

<p>
æ“ä½œ:<br>
ã‚¯ãƒªãƒƒã‚¯=é¸æŠ / ãƒ‰ãƒ©ãƒƒã‚°=ç§»å‹• / çŸ¢å°=å¾®èª¿æ•´ / Shift+çŸ¢å°=10px<br>
WASD=ã‚µã‚¤ã‚ºå¤‰æ›´ / Delete=å‰Šé™¤
</p>

<script>

/* =========================
   STATE
========================= */

let layout=[];
let layers=[{}];
let currentLayer=0;

let selected=null;
let dragging=false;
let offsetX, offsetY;

const stage=document.getElementById("stage");
const bg=document.getElementById("bg");


/* =========================
   ç”»åƒèª­ã¿è¾¼ã¿
========================= */

function loadImage(e){
    const file=e.target.files[0];
    const reader=new FileReader();

    reader.onload=()=>{
        bg.src=reader.result;
    };

    reader.readAsDataURL(file);
}


/* =========================
   ã‚­ãƒ¼ç”Ÿæˆ
========================= */

function addKey(){
    const id=Date.now();
    layout.push({id,x:50,y:50,w:70,h:70});
    render();
}


/* =========================
   æç”»
========================= */

function render(){

    document.querySelectorAll(".key").forEach(e=>e.remove());

    layout.forEach(k=>{

        const el=document.createElement("div");
        el.className="key";

        if(selected===k.id) el.classList.add("selected");

        el.style.left=k.x+"px";
        el.style.top=k.y+"px";
        el.style.width=k.w+"px";
        el.style.height=k.h+"px";

        el.textContent=layers[currentLayer][k.id]||"";

        /* ã‚¯ãƒªãƒƒã‚¯ */
        el.onclick=(ev)=>{
            ev.stopPropagation();
            selected=k.id;
            document.getElementById("keyInput").value=
                layers[currentLayer][k.id]||"";
            render();
        };

        /* ãƒ‰ãƒ©ãƒƒã‚° */
        el.onmousedown=(ev)=>{
            dragging=true;
            offsetX=ev.offsetX;
            offsetY=ev.offsetY;
        };

        stage.appendChild(el);
    });
}


/* =========================
   ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•
========================= */

stage.onmousemove=(e)=>{
    if(!dragging || selected==null) return;

    const rect=stage.getBoundingClientRect();
    const k=getSelected();

    k.x=e.clientX-rect.left-offsetX;
    k.y=e.clientY-rect.top-offsetY;

    render();
};

stage.onmouseup=()=>dragging=false;


/* =========================
   ã‚­ãƒ¼ã‚³ãƒ¼ãƒ‰
========================= */

function updateKey(v){
    if(selected==null)return;
    layers[currentLayer][selected]=v;
    render();
}


/* =========================
   ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
========================= */

document.addEventListener("keydown",e=>{
    if(selected==null)return;

    const step=e.shiftKey?10:1;
    const k=getSelected();

    switch(e.key){

        case "ArrowUp":k.y-=step;break;
        case "ArrowDown":k.y+=step;break;
        case "ArrowLeft":k.x-=step;break;
        case "ArrowRight":k.x+=step;break;

        case "w":k.h-=step;break;
        case "s":k.h+=step;break;
        case "a":k.w-=step;break;
        case "d":k.w+=step;break;

        case "Delete":
            layout=layout.filter(x=>x.id!==selected);
            selected=null;
            break;
    }

    render();
});


function getSelected(){
    return layout.find(k=>k.id===selected);
}


/* =========================
   ä¿å­˜/èª­è¾¼
========================= */

function save(){
    localStorage.setItem("layout",JSON.stringify(layout));
    localStorage.setItem("layers",JSON.stringify(layers));
    alert("ä¿å­˜ã—ã¾ã—ãŸ");
}

function load(){
    layout=JSON.parse(localStorage.getItem("layout")||"[]");
    layers=JSON.parse(localStorage.getItem("layers")||"[{}]");
    render();
}


/* =========================
   keymap.c ç”Ÿæˆ
========================= */

function exportKeymap(){

let txt="const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS]={\n";

layers.forEach((l,i)=>{
    txt+=`[${i}] = LAYOUT(\n`;
    txt+=layout.map(k=>l[k.id]||"KC_NO").join(", ");
    txt+="\n),\n";
});

txt+="};";

const blob=new Blob([txt]);
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="keymap.c";
a.click();
}


/* ========================= */

render();

</script>
</body>
</html>
